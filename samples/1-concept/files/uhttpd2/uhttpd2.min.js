/*
**	module.....: uhttpd2.js -- module control for uhttpd2 (Harbour)
**	version....: 0.81
**  last update: 21/08/2022
**
**	(c) 2022 by Carles Aubia
**
*/
const UHTTPD2_VERSION=0.81;function UHttpd2(){var t=new UDom;this.GetLive=function(e){var a,r=$("#"+e).find("[data-live]"),n={};for(i=0;i<r.length;i++){a=$(r[i]).attr("id");var o=$(r[i]).prop("type");if(n[a]={type:"input",value:t.Get(a)},"radio"===o){var l=$("#"+a).attr("name"),s=$("input[name="+l+"]:checked").val();n[l]={type:"radio",value:s}}}return n},this.InitOnChange=function(t){var e=$("#"+t).find("[data-onchange]");if(0==e.length)return null;var a=this.Duplicated_Ids(e,"onchange");if(a>0)return a;for(i=0;i<e.length;i++)id=$(e[i]).attr("id"),$("#"+id).bind("change",UOnChange);return 0},this.InitOnClick=function(t){var e=$("#"+t).find("[data-onclick]");if(0==e.length)return null;var a=this.Duplicated_Ids(e,"onclick");if(a>0)return a;for(i=0;i<e.length;i++)id=$(e[i]).attr("id"),$("#"+id).bind("click",UOnClick);return 0},this.InitOnInit=function(t){if(null==(cApi=$("#"+t).data("api")))return null;var e=$("#"+t).data("oninit");if(null==e)return null;var a={};a.dlg=t,a.api=cApi,a.proc=e,a.controls=JSON.stringify(this.GetLive(t)),UShoot("api",a)},this.Duplicated_Ids=function(t,e){var a=0;return $(t).each(function(){var t=$('[id="'+this.id+'"]');t.length>1&&t[0]==this&&(a++,console.warn(e+" -> Multiple IDs #"+this.id))}),a>0}}function UInitDialog(t){var e=new UHttpd2;console.log("InitDialog ready... => ",t);var a=0;a=e.InitOnChange(t),(a=e.InitOnClick(t))>0&&console.warn("Warning!, Dialog id => "+t+", maybe dont working correctly. Id's duplicated"),e.InitOnInit(t)}function UOnChange(){var t=event.target.id,e=$("#"+t).parents("[data-dialog]");if(0==e.length)return UMsgError("<b>Error: </b> html => data-dialog tag don't defined","Programming"),!1;var a=$(e[0]).attr("id"),r=$("#"+t).data("onchange"),n=new UHttpd2,o={};o.dlg=a,o.api=$("#"+a).data("api"),o.proc=r,o.controls=JSON.stringify(n.GetLive(a)),UShoot("api",o)}function UOnClick(){var selectElement,id=event.target.id,oDlg=$("#"+id).parents("[data-dialog]");if(0==oDlg.length)return UDialog("sys","<b>Error: </b> Html => data-dialog tag don't defined","Programming"),!1;var id_parent=$(oDlg[0]).attr("id"),proc=$("#"+id).data("onclick"),pbi=$("#"+id).data("pbi");if("string"==typeof pbi)try{var u=eval(pbi);if("boolean"!=typeof u||!1==u)return null}catch(e){var cError="<b>Parent Id:</b>"+id_parent+"<br><b>Id:</b> "+id+"<br><b>Error pai:</b> ";e instanceof SyntaxError?cError+=e.message:cError+=e,UMsg(cError,"System Error")}var oHttpd2=new UHttpd2,oPar={};oPar.dlg=id_parent,oPar.api=$("#"+id_parent).data("api"),oPar.proc=proc,oPar.controls=JSON.stringify(oHttpd2.GetLive(id_parent)),UShoot("api",oPar)}function UShoot(t,e){if($("#error").html(""),!e.api||""===e.api)return UMsgError("<b>Error: </b> html => data-api tag don't defined","Programming"),null;$.ajax({type:"POST",url:t,data:e,cache:!1,async:!1}).fail(function(t,e){UMsgError(t.responseText)}).done(function(t){var e=new UDom;if("string"==$.type(t)){if(0==t.length)return null;try{t=jQuery.parseJSON(t)}catch(a){t&&(t.replace(/(\n)+/g,"<br />"),UMsgError(t,"System Error"))}}if(t.confirm&&!confirm(t.confirm))return null;if(t.redirect){switch(t.redirect.type){case"dialog":UScreen("splash","dialog");break;case"url":location.replace(t.redirect.proc)}return null}if(t.url)return"_self"==t.url.target?window.location.replace(t.url.url):window.open(t.url.url,t.url.target,t.url.specs),null;if(t.screen&&("string"==typeof t.screen.proc?UScreen(t.screen.proc,t.screen.target,t.screen.id,t.screen.cargo):"_container"==t.screen.target&&$("#"+t.screen.id).html(t.screen.cargo)),t.setter)for(i=0;i<t.setter.length;i++)id=t.setter[i].id,value=t.setter[i].value,e.Set(id,value);if(t.active)for(i=0;i<t.active.length;i++)id=t.active[i].id,value=t.active[i].value,e.Active(id,value);if(t.test)for(i=0;i<t.test.length;i++){id=t.test[i].id,method=t.test[i].method,value=t.test[i].value;var r=Tabulator.findTable("#"+id)[0];r.addData(value);var t=r.getData();r.getRow(1).getData()}if(t.table)for(i=0;i<t.table.length;i++)id=t.table[i].id,action=t.table[i].action,value=t.table[i].value,msgconfirm=t.table[i].msgconfirm,new UTable(id,action,value,msgconfirm).Run();if(t.class)for(i=0;i<t.class.length;i++)id=t.class[i].id,value=t.class[i].class,action=t.class[i].action,e.Class(id,value,action);if(t.visibility)for(i=0;i<t.visibility.length;i++)id=t.visibility[i].id,action=t.visibility[i].action,e.Visibility(id,action);if(t.focus&&e.Focus(t.focus),t.js){var n=window[t.js.func];if("function"==typeof n)return n.apply(null,[t.js.data])}t.alert&&UMsg(t.alert,"System"),t.error&&UMsgError(t.error,"System Error"),t.dialog&&UDialog(t.dialog.id,t.dialog.html,t.dialog.title),t.dialogclose&&(id_dlg=$("#"+t.dialogclose).parent().attr("id"),!0==$("#"+id_dlg).hasClass("ui-dialog-content")&&($("#"+id_dlg).dialog("close"),$("#"+id_dlg).dialog("destroy").remove()))})}function UTable(t,e,a,r){var n;this.id=t,this.action=e,this.value=a,this.msgconfirm=r,void 0===UTable.rowsDeleted&&(UTable.rowsDeleted={}),this.Init=function(){if(aColumns="object"==typeof a.columns?a.columns:[],aData="object"==typeof a.data?a.data:[],aConfig="object"==typeof a.config?a.config:[],(aPerformance="object"==typeof a.performance?a.performance:null)&&"array"==$.type(a.columns))for(var e=0;e<a.columns.length;e++){switch("array"!=$.type(a.columns[e].validator)&&(a.columns[e].validator=[]),a.columns[e].formatter){case"UFormatDate":a.columns[e].validator.push({type:this.FormatDate,parameters:a.columns[e].editorParams});break;case"UFormatLogic":a.columns[e].formatter=this.FormatLogic}"direct"===aPerformance.type&&a.columns[e].validator.push({type:this.TableDirect,parameters:{id:aPerformance.id,id_key:aPerformance.id_key,api:aPerformance.api,proc:aPerformance.proc,file:aPerformance.file}})}var r={columns:aColumns,data:aData};for(var o in aConfig)r[o]=aConfig[o];(n=new Tabulator("#"+t,r)).on("rowUpdated",function(t){console.log("rowUpdated",t)}),n.on("rowDblClick",function(t,e){console.log("rowDblClick",e.getData())}),n.on("cellEdited",function(t){var e={};e._recno=t.getData()._recno,e.value=t.getValue(),e.field=t.getColumn().getField()})},this.Instance=function(){return n=Tabulator.findTable("#"+this.id)[0]},this.Run=function(t){switch(t="string"==typeof t?t:this.action){case"init":this.Init();break;case"resetData":if("object"!=typeof(n=this.Instance()))return null;n.setData(),n.clearCellEdited(),UTable.rowsDeleted={};break;case"addData":if("object"!=typeof(n=this.Instance()))return null;n.addData(this.value.data,this.value.top);break;case"getData":if("object"!=typeof(n=this.Instance()))return null;var e=n.getRows(),a={};return e.forEach(function(t){a[t.getIndex()]=t.getData()}),a;case"getSelectedData":if("object"!=typeof(n=this.Instance()))return null;return n.getSelectedData();case"getDataDeleted":return UTable.rowsDeleted;case"getDataChanged":if("object"!=typeof(n=this.Instance()))return null;var e=n.getEditedCells(),a={};return e.forEach(function(t){var e=t.getRow().getIndex();e in a||(a[e]=t.getRow().getData())}),a;case"getEditedCells":var e=(n=this.Instance()).getEditedCells();let r=new Set;for(let o of(e.forEach(function(t){r.add(t.getRow())}),r))console.log(o.getData());n.clearCellEdited(),e=n.getEditedCells();var l=n.getDataCount();for(n.getRows(),i=1;i<=l;i++)n.getRow(i);break;case"clearEdited":if("object"!=typeof(n=this.Instance()))return null;n.clearCellEdited(),UTable.rowsDeleted={};break;case"deleteRow":if("object"!=typeof(n=this.Instance()))return null;var s=n.getSelectedData();if(0==s.length||this.msgconfirm&&!confirm(this.msgconfirm))return null;var c=[];for(let d in s)c.push(s[d].id),UTable.rowsDeleted[d]=s[d];n.deleteRow(c);break;case"alert":if("object"!=typeof(n=this.Instance()))return null;n.alert(this.value)}},this.TableDirect=function(t,e,a){var r=t.getColumn().getField();if(e==t.getData()[r])return!0;var n=!1,o=null;if(a.id,a.api&&a.proc){var l={};l.api=a.api,l.proc=a.proc,l.dlg="*";var s=a.id_key,c={};c["*-file"]={type:"input",value:a.file},c["*-"+s]={type:"input",value:t.getData()[s]},c["*-value"]={type:"input",value:e},c["*-field"]={type:"input",value:t.getColumn().getField()},l.controls=JSON.stringify(c);var d=$.ajax({type:"POST",url:"api",data:l,async:!1});d.done(function(t){try{t=jQuery.parseJSON(t)}catch(e){t&&(t.replace(/(\n)+/g,"<br />"),UMsg(t,"System Error"))}if(t.data&&(!0==t.data.updated&&(n=!0),t.data.msg&&(o=t.data.msg)),t.confirm&&!confirm(t.confirm))return null;t.screen&&("string"==typeof t.screen.proc?UScreen(t.screen.proc,t.screen.target,t.screen.id,t.screen.cargo):"_container"==t.screen.target&&$("#"+t.screen.id).html(t.screen.cargo))}),d.fail(function(t,e){console.log("FAIL2-",e),console.log("Error-2",t)}),d.always(function(){})}return!!n||(o&&UMsg(o,"System"),t.getElement().focus(),!1)},this.FormatDate=function(t,e,a){return moment(e,a.inputFormat,!0).isValid()},this.FormatLogic=function(t,e,a){var r="";return t.getValue()?e.yes&&(r='<img src="'+e.yes+'" width="'+e.width+'" height="'+e.height+'" ></img>'):e.no&&(r='<img src="'+e.no+'" width="'+e.width+'" height="'+e.height+'" ></img>'),r}}function UScreenClean(t){$("#"+t).html("")}function UScreen(t,e,a,r){e="string"==typeof e?e:"container",a="string"==typeof a&&a.length>0?a:t,r="string"==typeof r?r:"",$("#error").html("");var n={};n.dlg=a,n.type=e,$.post(t,n).done(function(n){if(!1==n.success)return n.redirect?UScreen(n.redirect.proc,n.redirect.type):UDialog("sys",n.msg,"System Error"),null;switch(e){case"_container":if(0==$("#"+a).length){var o=document.createElement("div");o.id=a,document.body.appendChild(o)}$("#"+a).html(n.html);break;case"_dialog":if($("#"+a).length>0)return null;var l="_dlg_"+a;if(0!=$("#"+l).length)return null;var s=document.createElement("div");s.id=l,document.body.appendChild(s),0==r.length&&(r="Dialog"),$("#"+l).addClass("TDlg_body").html(n.html).dialog({width:"auto",height:"auto",resizable:!1,title:r,dialogClass:"TDlg",close:function(){$(this).dialog("destroy").remove()}});break;case"_window":console.log("_window",t),window.open(t,"MyWind",a)}}).fail(function(e,a){switch(console.log("Error",e),e.readyState){case 4:UMsgError("<b>Route:</b> "+t+"<hr><br>"+e.responseText,"Error");break;case 0:UMsgError("<b>Network error !</b>","Error")}})}function UMsg(t,e){IsBootstrap()?UModal(t,e,"info"):UDialog("_msg_",t,e,"TDlg_Msg","info")}function UMsgError(t,e){IsBootstrap()?UModal(t,e,"error"):UDialog("_msg_",t,e,"TDlg_Msg","error")}function UDialog(t,e,a,r,n){if(a="string"==typeof a?a:"",r="string"==typeof r?r:"TDlg_Msg",0!=$("#"+(t="string"==typeof t?t:"_msg_")).length)return console.warn("Dialog exist id => "+t),null;var o=document.createElement("div");switch(o.id=t,document.body.appendChild(o),n){case"info":default:a=""===a?"Information":a;break;case"error":a=""===a?"Error System":a}var l=.8*$(window).width(),s=.8*$(window).height();switch(n){case"info":default:MsgSound("files/uhttpd2/sound/msg.mp3");break;case"error":MsgSound("files/uhttpd2/sound/msg_error.mp3")}return $("#"+t).html(e).dialog({width:"auto",height:"auto",maxWidth:l,maxHeight:s,minHeight:"auto",modal:!0,resizable:!1,title:a,dialogClass:r,close:function(){$(this).dialog("destroy").remove()}}),null}function UModal(t,e,a){switch(e="string"==typeof e?e:"",a){case"info":default:e=""===e?"Information":e;break;case"error":e=""===e?"Error System":e}var r='<div class="modal fade">  <div class="modal-dialog">    <div class="modal-content">';e.length>0&&(r+='      <div class="modal-header">        <h4 class="modal-title">'+e+'</h4>        <button type="button" class="close" data-dismiss="modal">&times;</button>      </div>'),r+='      <div class="modal-body" >'+t+"</body>",$(r+="    </div>  </div></div>").modal()}function IsBootstrap(){return"function"==typeof $().modal}function UDom(){this.Set=function(t,e){var a=$("#"+t).prop("type");switch(a){case"password":case"textarea":case"text":case"select-one":$("#"+t).val(e);break;case"checkbox":$("#"+t).prop("checked",e);break;default:$("#"+t).html(e)}},this.Get=function(t){var e=$("#"+t).prop("type"),a="";switch(e){case"password":case"textarea":case"text":case"select-one":a=$("#"+t).val();break;case"checkbox":a=$("#"+t).is(":checked");break;case"radio":void 0===(a=$("input[name="+t+"]:checked").val())&&(a=0);break;default:var r=$("#"+t).attr("class");if("string"==typeof r&&r.indexOf("TGrid")>=0){var n=new UTable(t);aData=(lAll="string"==typeof $("#"+t).data("all"))?n.Run("getData"):[],a={updated:n.Run("getDataChanged"),deleted:n.Run("getDataDeleted"),selected:n.Run("getSelectedData"),data:aData}}else a=$("#"+t).html()}return a},this.Array2TBody=function(t){var e="";if(t.length>0)for(i=0;i<t.length;i++){for(e+="<tr>",j=0;j<t[i].length;j++)(e+="<td>","boolean"==(cType=typeof t[i][j]))?e+='<input type="checkbox" id="vehicle1" name="vehicle1" value="">':e+=t[i][j].toString(),e+="</td>";e+="</tr>"}return e},this.Active=function(t,e){var a=$("#"+t).prop("type");switch(a){case"text":case"checkbox":case"button":case"select-one":$("#"+t).prop("disabled",!e);break;default:$("#"+t).html(e)}},this.Class=function(t,e,a){switch(a){case"toggle":$("#"+t).toggleClass(e);break;case"on":$("#"+t).addClass(e);break;case"off":$("#"+t).removeClass(e)}},this.Visibility=function(t,e){switch(e){case"toggle":$("#"+t).toggle();break;case"on":$("#"+t).show();break;case"off":$("#"+t).hide()}},this.Focus=function(t){$("#"+t).focus(),$("#"+t).select()}}function MsgSound(t){var e=document.createElement("audio");e.setAttribute("src",t),e.setAttribute("autoplay","autoplay")}$(document).ready(function(){console.info("UHTTPD2 "+UHTTPD2_VERSION)});