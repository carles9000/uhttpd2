/*
**	module.....: uhttpd2.js -- module control for uhttpd2 (Harbour)
**	version....: 0.98a
**  last update: 24/12/2022
**
**	(c) 2022 by Carles Aubia
**
*/
const UHTTPD2_VERSION="0.98a";function UHttpd2(){var e=new UDom;void 0===UHttpd2.dialog&&(UHttpd2.dialog={}),this.SetDialog=function(e){UHttpd2.dialog.function=e},this.dlg=function(){return UHttpd2.dialog},this.GetLive=function(t){var r,a=$("#"+t).find("[data-live]"),n={};for(i=0;i<a.length;i++){r=$(a[i]).attr("id");var o=$(a[i]).prop("type");if(n[r]={type:"input",value:e.Get(r)},"radio"===o){var l=$("#"+r).attr("name"),s=$("input[name="+l+"]:checked").val();n[l]={type:"radio",value:s}}}return n},this.InitOnChange=function(e){var t=$("#"+e).find("[data-onchange]");if(0==t.length)return null;var r=this.Duplicated_Ids(t,"onchange");if(r>0)return r;for(i=0;i<t.length;i++)id=$(t[i]).attr("id"),$("#"+id).bind("change",UOnChange);return 0},this.InitOnClick=function(e){var t=$("#"+e).find("[data-onclick]");if(0==t.length)return null;var r=this.Duplicated_Ids(t,"onclick");if(r>0)return r;for(i=0;i<t.length;i++)id=$(t[i]).attr("id"),$("#"+id).bind("click",UOnClick);return 0},this.InitOnInit=function(e){if(null==(cApi=$("#"+e).data("api")))return null;var t=$("#"+e).data("oninit");if(null==t)return null;var r={};r.dlg=e,r.api=cApi,r.proc=t,r.controls=JSON.stringify(this.GetLive(e)),UShoot("api",r)},this.Duplicated_Ids=function(e,t){var r=0;return $(e).each(function(){var e=$('[id="'+this.id+'"]');e.length>1&&e[0]==this&&(r++,console.warn(t+" -> Multiple IDs #"+this.id))}),r}}function UInitDialog(e){var t=new UHttpd2;console.log("InitDialog ready... => ",e);var r=0;r=t.InitOnChange(e),(r=t.InitOnClick(e))>0&&console.warn("Warning!, Dialog id => "+e+", maybe dont working correctly. Id's duplicated"),t.InitOnInit(e)}function UOnChange(e){var t=event.target;"object"==typeof e&&(e=""==t.id?t.offsetParent.id:t.id);var r=$("#"+e).parents("[data-dialog]");if(0==r.length)return UMsgError("<b>Error: </b> html => data-dialog tag don't defined","Programming"),!1;var a=$(r[0]).attr("id"),n=$("#"+e).data("onchange"),o=new UHttpd2,l={};l.dlg=a,l.api=$("#"+a).data("api"),l.proc=n,l.controls=JSON.stringify(o.GetLive(a)),UShoot("api",l)}function UOnClick(){var o,id,selectElement=event.target,oDlg=$("#"+(id=""==selectElement.id?selectElement.offsetParent.id:selectElement.id)).parents("[data-dialog]");if(0==oDlg.length)return UDialog("sys","<b>Error: </b> Html => data-dialog tag don't defined","Programming"),!1;var id_parent=$(oDlg[0]).attr("id"),proc=$("#"+id).data("onclick"),pbi=$("#"+id).data("pbi");if("string"==typeof pbi)try{var u=eval(pbi);if("boolean"!=typeof u||!1==u)return null}catch(e){var cError="<b>Parent Id:</b>"+id_parent+"<br><b>Id:</b> "+id+"<br><b>Error pai:</b> ";e instanceof SyntaxError?cError+=e.message:cError+=e,UMsg(cError,"System Error")}var oHttpd2=new UHttpd2,oPar={};oPar.dlg=id_parent,oPar.api=$("#"+id_parent).data("api"),oPar.proc=proc,oPar.controls=JSON.stringify(oHttpd2.GetLive(id_parent));var cId_Files=$("#"+id).data("upload");if(cId_Files){if(1!=$("#"+cId_Files).length)return UMsgError("Error data-upload: "+cId_Files),null;UFileUpload(cId_Files,oPar)}else UShoot("api",oPar)}function UFileUpload(e,t,r,a){var n=new FormData,o=$("#"+e)[0].files.length,l="object"==$.type(t);if(0==o)return null;if(l){var s=new UHttpd2;n.append("dlg",t.dlg),n.append("api",t.api),n.append("proc",t.proc),n.append("controls",JSON.stringify(s.GetLive(t.dlg)))}else{if("function"!=typeof r)return UMsgError("UFileUpload error. Callback is missing"),null;"object"==$.type(a)&&$.each(a,(e,t)=>{n.append(e,t)})}for(i=0;i<o;i++){var c=$("#"+e)[0].files[i];n.append("file",c)}l?UShoot("api",n,!0):UShoot(t,n,!0,r)}function MsgApi(e,t,r){var a=$("[data-api='"+e+"']");if(1!=a.length)return console.error("Api not found: "+e),null;var n=new UHttpd2,o=a.attr("id");if("string"!=typeof o)return console.error("ID not defined in form with Api: "+e),null;var l=n.GetLive(o),s={};if(s.dlg=o,s.api=e,s.proc=t,s.controls=null,"object"==$.type(r))for(let c in r)r.hasOwnProperty(c)&&(l[o+"-"+c]={type:"param",value:r[c]});s.controls=JSON.stringify(l),UShoot("api",s)}function UShoot(e,t,r,a){if(r="boolean"==typeof r&&r);else if(!t.api||""===t.api)return UMsgError("<b>Error: </b> html => data-api tag don't defined","Programming"),null;var n={type:"POST",url:e,data:t,cache:!1,async:!1};r&&(n.processData=!1,n.contentType=!1);var o=$.ajax(n).fail(function(e,t){switch(e.readyState){case 4:UMsgError("<b>Route:</b> "+cName+"<hr><br>"+e.responseText,"Error");break;case 0:UMsgError("<b>Network error !</b>","Error")}});"function"==typeof a?o.done(function(e){return a.apply(null,[e])}):o.done(function(e){var t=new UDom;if("string"==$.type(e)){if(0==e.length)return null;try{e=jQuery.parseJSON(e)}catch(r){e&&(e.replace(/(\n)+/g,"<br />"),UMsgError(e,"System Error"))}}if(e.trace&&console.info("TRACE",e),e.console)for(i=0;i<e.console.length;i++)e.console[i][1]?console.info(e.console[i][1],e.console[i][0]):console.info(e.console[i][0]);if(e.confirm&&!confirm(e.confirm))return null;if(e.redirect){switch(e.redirect.type){case"dialog":UScreen("splash","dialog");break;case"url":location.replace(e.redirect.proc)}return null}if(e.url)return"_self"==e.url.target?window.location.replace(e.url.url):window.open(e.url.url,e.url.target,e.url.specs),null;if(e.screen&&("string"==typeof e.screen.proc?UScreen(e.screen.proc,e.screen.target,e.screen.id,e.screen.cargo):"_container"==e.screen.target&&$("#"+e.screen.id).html(e.screen.cargo)),e.setter)for(i=0;i<e.setter.length;i++)id=e.setter[i].id,value=e.setter[i].value,t.Set(id,value);if(e.active)for(i=0;i<e.active.length;i++)id=e.active[i].id,value=e.active[i].value,t.Active(id,value);if(e.table)for(i=0;i<e.table.length;i++){id=e.table[i].id,action=e.table[i].action,value=e.table[i].value,msgconfirm=e.table[i].msgconfirm;var a=new UTabulator(id);"init"==action?a.Init(value.options,value.events,value.filter,value.cargo):a.Proc(action,value)}if(e.class)for(i=0;i<e.class.length;i++)id=e.class[i].id,value=e.class[i].class,action=e.class[i].action,t.Class(id,value,action);if(e.visibility)for(i=0;i<e.visibility.length;i++)id=e.visibility[i].id,action=e.visibility[i].action,t.Visibility(id,action);if(e.focus&&t.Focus(e.focus),e.js){var n=window[e.js.func];if("function"==typeof n)return n.apply(null,[e.js.data])}e.error&&UMsgError(e.error,"System Error"),e.dialog&&UDialog(e.dialog.id,e.dialog.html,e.dialog.title),e.alert&&UMsg(e.alert,"System"),e.dialogclose&&(id_dlg=$("#"+e.dialogclose).parent().attr("id"),!0==$("#"+id_dlg).hasClass("ui-dialog-content")&&($("#"+id_dlg).dialog("close"),$("#"+id_dlg).dialog("destroy").remove()))})}function UScreenClean(e){$("#"+e).html("")}function UScreen(e,t,r,a){t="string"==typeof t?t:"container",r="string"==typeof r&&r.length>0?r:e,a="string"==typeof a?a:"",$("#error").html("");var n={};n.dlg=r,n.type=t,$.post(e,n).done(function(n){if(!1==n.success)return n.redirect?UScreen(n.redirect.proc,n.redirect.type):UDialog("sys",n.msg,"System Error"),null;switch(t){case"_container":if(0==$("#"+r).length){var o=document.createElement("div");o.id=r,document.body.appendChild(o)}$("#"+r).html(n.html);break;case"_dialog":if($("#"+r).length>0)return null;var l="_dlg_"+r;if(0!=$("#"+l).length)return null;var s=document.createElement("div");s.id=l,document.body.appendChild(s),0==a.length&&(a="Dialog"),$("#"+l).addClass("TDlg_body").html(n.html).dialog({width:"auto",height:"auto",resizable:!1,title:a,dialogClass:"TDlg",close:function(){$(this).dialog("destroy").remove()}});break;case"_window":console.log("_window",e),window.open(e,"MyWind",r)}}).fail(function(t,r){switch(console.log("Error",t),t.readyState){case 4:UMsgError("<b>Route:</b> "+e+"<hr><br>"+t.responseText,"Error");break;case 0:UMsgError("<b>Network error !</b>","Error")}})}function UMsg(e,t){IsBootstrap()?UModal(e,t,"info"):UDialog("_msg_",e,t,"TDlg_Msg","info")}function UMsgError(e,t){IsBootstrap()?UModal(e,t,"error"):UDialog("_msg_",e,t,"TDlg_Msg","error")}function UDialog(e,t,r,a,n){if(r="string"==typeof r?r:"",a="string"==typeof a?a:"TDlg_Msg",0!=$("#"+(e="string"==typeof e?e:"_msg_")).length)return console.warn("Dialog exist id => "+e),null;var o=document.createElement("div");switch(o.id=e,document.body.appendChild(o),n){case"info":default:r=""===r?"Information":r;break;case"error":r=""===r?"Error System":r}var l=.8*$(window).width(),s=.8*$(window).height();switch(n){case"info":default:MsgSound("files/uhttpd2/sound/msg.mp3");break;case"error":MsgSound("files/uhttpd2/sound/msg_error.mp3")}return $("#"+e).html(t).dialog({width:"auto",height:"auto",maxWidth:l,maxHeight:s,minHeight:"auto",title:r,modal:!0,resizable:!1,dialogClass:a,open:function(){},close:function(){$(this).dialog("destroy").remove()}}),null}function UModal(e,t,r){switch(t="string"==typeof t?t:"",r){case"info":default:t=""===t?"Information":t;break;case"error":t=""===t?"Error System":t}var a='<div class="modal fade">  <div class="modal-dialog">    <div class="modal-content">';t.length>0&&(a+='      <div class="modal-header">        <h4 class="modal-title">'+t+'</h4>        <button type="button" class="close" data-dismiss="modal">&times;</button>      </div>'),a+='      <div class="modal-body" >'+e+"</body>",$(a+="    </div>  </div></div>").modal()}function IsBootstrap(){return"function"==typeof $().modal}function UDom(){this.Set=function(e,t){var r=$("#"+e).prop("type");switch(null==r&&("radio"==$("input:radio[name="+e+"]").prop("type")?r="radio":$("#"+e).is("img")&&(r="image")),r){case"hidden":case"password":case"time":case"email":case"tel":case"number":case"date":case"textarea":case"text":$("#"+e).val(t);break;case"checkbox":$("#"+e).prop("checked",t);break;case"radio":""!=t?$("input[name="+e+'][ value="'+t+'"]').prop("checked",!0):$("input[name="+e+"]").prop("checked",!1);break;case"select-one":"object"==$.type(t)?($("#"+e).empty(),$.each(t,function(t,r){$("#"+e).append($("<option>",{value:t}).text(r))})):$("#"+e).val(t);break;case"image":$("#"+e).attr("src",t);break;default:$("#"+e).html(t)}},this.Get=function(e){var t=$("#"+e).prop("type"),r="";switch(null==t&&("radio"==$("input:radio[name="+e+"]").prop("type")?t="radio":$("#"+e).is("img")&&(t="image")),t){case"hidden":case"password":case"time":case"email":case"tel":case"number":case"date":case"textarea":case"text":case"select-one":r=$("#"+e).val();break;case"checkbox":r=$("#"+e).is(":checked");break;case"radio":void 0===(r=$("input[name="+e+"]:checked").val())&&(r=0);break;case"image":r=$("#"+e).attr("src");break;default:var a=$("#"+e).attr("class");if("string"==typeof a){if(a.indexOf("TGrid")>=0){alert("Old version. Not working"),r.selected={},r.updated={},r.data={};break}if(a.indexOf("tabulator")>=0){var n=$("#"+e).data("all");n="string"==typeof n?"SUA":"SU",r={};var o=new UTabulator(e);if(void 0===o.table)return r.selected={},r.updated={},r.data={},r;n.indexOf("S")>=0&&(r.selected=o.Proc("getSelectedData")),n.indexOf("U")>=0&&(r.updated=o.Proc("getDataChanged")),n.indexOf("A")>=0&&(r.data=o.Proc("getData"))}}else r=$("#"+e).html()}return r},this.Array2TBody=function(e){var t="";if(e.length>0)for(i=0;i<e.length;i++){for(t+="<tr>",j=0;j<e[i].length;j++)(t+="<td>","boolean"==(cType=typeof e[i][j]))?t+='<input type="checkbox" id="vehicle1" name="vehicle1" value="">':t+=e[i][j].toString(),t+="</td>";t+="</tr>"}return t},this.Active=function(e,t){var r=$("#"+e).prop("type");switch(r){case"text":case"checkbox":case"submit":case"button":case"select-one":$("#"+e).prop("disabled",!t);break;default:$("#"+e).html(t)}},this.Class=function(e,t,r){switch(r){case"toggle":$("#"+e).toggleClass(t);break;case"on":$("#"+e).addClass(t);break;case"off":$("#"+e).removeClass(t)}},this.Visibility=function(e,t){switch(t){case"toggle":$("#"+e).toggle();break;case"on":$("#"+e).show();break;case"off":$("#"+e).hide()}},this.Focus=function(e){$("#"+e).focus(),$("#"+e).select()}}function MsgSound(e){var t=document.createElement("audio");t.setAttribute("src",e),t.setAttribute("autoplay","autoplay")}$(document).ready(function(){console.info("UHTTPD2 "+UHTTPD2_VERSION)});